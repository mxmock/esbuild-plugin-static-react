"use strict";var rt=Object.create;var x=Object.defineProperty;var nt=Object.getOwnPropertyDescriptor;var st=Object.getOwnPropertyNames;var ot=Object.getPrototypeOf,it=Object.prototype.hasOwnProperty;var ct=(t,e)=>{for(var r in e)x(t,r,{get:e[r],enumerable:!0})},R=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of st(e))!it.call(t,s)&&s!==r&&x(t,s,{get:()=>e[s],enumerable:!(n=nt(e,s))||n.enumerable});return t};var a=(t,e,r)=>(r=t!=null?rt(ot(t)):{},R(e||!t||!t.__esModule?x(r,"default",{value:t,enumerable:!0}):r,t)),at=t=>R(x({},"__esModule",{value:!0}),t);var wt={};ct(wt,{default:()=>Pt});module.exports=at(wt);var f=a(require("path"));var $=a(require("path")),J=a(require("sass")),B=a(require("postcss")),H=a(require("cssnano")),L=a(require("autoprefixer"));var j=a(require("path")),E=require("html-minifier-terser");var h=require("fs"),S=t=>new Promise((e,r)=>{(0,h.mkdir)(t,{recursive:!0},n=>{n&&r(n.message),e("Create folder ok")})}),W=t=>new Promise((e,r)=>{(0,h.rm)(t,{recursive:!0,force:!0},n=>{n&&r(n.message),e("Delete ok")})});var P=require("fs"),mt=(t,e="utf8")=>(t.setEncoding(e),new Promise((r,n)=>{let s="";t.on("data",o=>{s+=o}),t.on("end",()=>r(s)),t.on("error",o=>n(o))})),T=(t,e)=>(t.write(e),t.end(),new Promise((r,n)=>{t.on("finish",()=>r("Write stream finish")),t.on("error",s=>n(s.message))})),A=async t=>{let e="";try{let r=(0,P.createReadStream)(t,{highWaterMark:100}),n=await mt(r);e=await(0,E.minify)(n,{caseSensitive:!0,collapseWhitespace:!0,conservativeCollapse:!0})}catch(r){console.error(r.message)}finally{return{path:t,content:e}}},N=async t=>{try{await S(j.default.dirname(t.path));let e=(0,P.createWriteStream)(t.path);await T(e,t.content)}catch(e){console.log(e)}},z=async(t,e)=>{try{await S(j.default.dirname(t));let r=(0,P.createWriteStream)(t);await T(r,e)}catch(r){console.log(r)}};var lt=t=>typeof t=="string",u=t=>lt(t)&&t.length>0;var M=a(require("cssnano-preset-default")),U=async(t,e,r,n)=>{if(!u(t)||!u(e))return;let s=(0,M.default)(),o=$.default.join(r,e,t);try{let{css:i}=await J.default.compileAsync(o),g=await(0,B.default)([(0,H.default)({preset:s,plugins:[L.default]})]).process(i,{from:void 0}),m=`${$.default.basename(t,".scss")}.css`,l=$.default.join(n,e,m);await z(l,`${g.css}`)}catch(i){console.error(i.message)}};var _=require("react-redux"),q=require("react-dom/server"),b=require("react/jsx-runtime"),G=(t,e,r,n)=>{let{id:s,Content:o}=t,i=`id="${s}"`,g=`data-${s}=`;if(!e.includes(i))return{log:"",html:e};let m=e.indexOf(i),l=dt(e,g,m),p=n?(0,b.jsx)(_.Provider,{store:n,children:(0,b.jsx)(o,{...l})}):(0,b.jsx)(o,{...l}),v=(0,q.renderToString)(p),w=`${s} injected in ${r}`;return{log:l&&Object.keys(l).length>0?`${w} with data ${JSON.stringify(l)}`:w,html:gt(v,e,m,i.length+1)}},dt=(t,e,r)=>{if(!t.includes(e))return{};let n=t.indexOf(e)+e.length+1,s=r-2,o=t.substring(n,s);try{return JSON.parse(o)}catch(i){return console.error(`getComponentData - cannot parse ${o} from html:`,i.message),{}}},gt=(t,e,r,n)=>{let s=e.substring(0,r+n),o=e.substring(r+n);return`${s}${t}${o}`};var k=a(require("path")),K=require("fs");var I=t=>new Promise((e,r)=>{(0,K.readdir)(t,{recursive:!0,withFileTypes:!0},(n,s)=>{n&&r(n),e(s)})}),Q=async(t,e)=>{let r=await I(t),n=await I(e);return{jsFolder:r,cssFolder:n}},V=async t=>{let e=[];try{let r=k.default.resolve(t),s=(await I(r)).filter(o=>o.name.includes(".html")).map(o=>{let i=k.default.resolve(o.path,o.name);return A(i)});e=await Promise.all(s)}catch(r){console.error(r)}finally{return e}};var d=a(require("path")),X=(t,e,r)=>{let n=r.indexOf(e),s=r.slice(n+e.length);return d.default.join(t,s)},Y=(t,e)=>{let{content:r,path:n}=t,{jsFolder:s,cssFolder:o}=e,i=pt(r),g=s.reduce(ut(n),""),m=o.reduce(ft(n),"");return i=i.replace(" </head>",`${m}</head>`),i.replace(" </body>",`${g}</body>`)},pt=t=>{let e=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>|<link\b[^>]*?rel="stylesheet"[^>]*?>/gi;return t.replace(e,"")},ut=t=>(e,r)=>{let n=d.default.relative(d.default.dirname(t),r.path),o=`<script defer async src="${d.default.join(n,r.name)}"></script>`;return`${e}${o} `},ft=t=>(e,r)=>{let n=d.default.relative(d.default.dirname(t),r.path),o=`<link rel="stylesheet" href="${d.default.join(n,r.name)}">`;return`${e}${o} `};var ht=(t={})=>({name:"staticReactPlugin",setup:e=>{let r=process.cwd(),n=t.css?.dir,s=t.store||null,o=t.css?.name,i=C(t.pagesDir),g=C(t.jsOutDir),m=C(t.srcDir,r),l=t.components||[],p=C(t.outDir||"build",r);e.onStart(async()=>{await W(p),console.log("Create optimized css..."),await U(o,n,m,p)}),e.onEnd(async()=>{console.log("Reading pages...");let v=await V(f.default.resolve(m,i)),w=await Q(f.default.resolve(p,g),f.default.resolve(p,n)),D=[],Z=v.map(c=>{for(let y of l){let F=f.default.basename(c.path),{html:et,log:O}=G(y,c.content,F,s);u(O)&&D.push(O),c.content=et}return c.path=X(p,i,c.path),c.content=Y(c,w),N(c)}),tt=D.reduce((c,y,F)=>F===0?y:`${c}, ${y}`,"Injected components:");console.log(`${tt}`),console.log("Creating optimized html..."),await Promise.all(Z)})}}),C=(t,e=null)=>{if(!u(t))throw new Error("Path must be a valid string");return e?f.default.resolve(e,t):t},Pt=ht;
