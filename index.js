"use strict";var Q=Object.create;var v=Object.defineProperty;var V=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,Z=Object.prototype.hasOwnProperty;var tt=(t,e)=>{for(var n in e)v(t,n,{get:e[n],enumerable:!0})},D=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of X(e))!Z.call(t,o)&&o!==n&&v(t,o,{get:()=>e[o],enumerable:!(r=V(e,o))||r.enumerable});return t};var x=(t,e,n)=>(n=t!=null?Q(Y(t)):{},D(e||!t||!t.__esModule?v(n,"default",{value:t,enumerable:!0}):n,t)),et=t=>D(v({},"__esModule",{value:!0}),t);var pt={};tt(pt,{default:()=>gt});module.exports=et(pt);var w=x(require("path"));var E=x(require("path")),A=require("html-minifier-terser");var h=require("fs"),j=t=>new Promise((e,n)=>{(0,h.mkdir)(t,{recursive:!0},r=>{r&&n(r.message),e("Create folder ok")})}),I=t=>new Promise((e,n)=>{(0,h.rm)(t,{recursive:!0,force:!0},r=>{r&&n(r.message),e("Delete ok")})}),R=(t,e)=>new Promise((n,r)=>{(0,h.cp)(t,e,{recursive:!0},o=>{o&&r(o.message),n("Copy ok")})});var S=require("fs"),nt=(t,e="utf8")=>(t.setEncoding(e),new Promise((n,r)=>{let o="";t.on("data",s=>{o+=s}),t.on("end",()=>n(o)),t.on("error",s=>r(s))})),rt=(t,e)=>(t.write(e),t.end(),new Promise((n,r)=>{t.on("finish",()=>n("Write stream finish")),t.on("error",o=>r(o.message))})),W=async t=>{let e="";try{let n=(0,S.createReadStream)(t,{highWaterMark:100}),r=await nt(n);e=await(0,A.minify)(r,{caseSensitive:!0,collapseWhitespace:!0,conservativeCollapse:!0})}catch(n){console.error(n.message)}return{path:t,content:e}},N=async t=>{try{await j(E.default.dirname(t.path));let e=(0,S.createWriteStream)(t.path);await rt(e,t.content)}catch(e){console.log(e)}};var ot=t=>typeof t=="string",p=t=>ot(t)&&t.length>0;var T=require("react-redux"),H=require("react-dom/server"),F=require("react/jsx-runtime"),J=(t,e,n,r)=>{let{id:o,Content:s}=t,i=`id="${o}"`,a=`data-${o}=`;if(!e.includes(i))return{log:"",html:e};let m=e.indexOf(i),c=st(e,a,m),g=r?(0,F.jsx)(T.Provider,{store:r,children:(0,F.jsx)(s,{...c})}):(0,F.jsx)(s,{...c}),P=(0,H.renderToString)(g),f=`${o} injected in ${n}`;return{log:c&&Object.keys(c).length>0?`${f} with data ${JSON.stringify(c)}`:f,html:it(P,e,m,i.length+1)}},st=(t,e,n)=>{if(!t.includes(e))return{};let r=t.indexOf(e)+e.length+1,o=n-2,s=t.substring(r,o);try{return JSON.parse(s)}catch(i){return console.error(`getComponentData - cannot parse ${s} from html:`,i.message),{}}},it=(t,e,n,r)=>{let o=e.substring(0,n+r),s=e.substring(n+r);return`${o}${t}${s}`};var l=x(require("path")),L=(t,e,n)=>{let r=n.indexOf(e),o=n.slice(r+e.length);return l.default.join(t,o)},B=(t,e)=>`${l.default.relative(l.default.dirname(t),l.default.dirname(e))}/${l.default.basename(e)}`,at=(t,e,n,r,o)=>{let s=t;for(let i=0;i<r.length;i++){let a=r[i],m=a.name,c=o.find(g=>g.name===m);if(c&&m.includes(".")&&s.includes(m)){let g=l.default.resolve(a.parentPath||a.path,a.name),P=l.default.resolve(c.parentPath||c.path,c.name),f=B(e,g),y=B(n,P);s=s.replace(f,y)}}return s},M=(t,e,n)=>{let{content:r,path:o}=t,{assetsSrcFolder:s,assetsOutFolder:i}=n,a=ct(r),m=i.reduce(lt(o),""),c=i.reduce(mt(o),"");return a=a.replace(" </head>",`${c}</head>`),a=a.replace(" </body>",`${m}</body>`),at(a,e,o,s,i)},ct=t=>{let e=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>|<link\b[^>]*?rel="stylesheet"[^>]*?>/gi;return t.replace(e,"")},lt=t=>(e,n)=>{if(!n.name.includes(".js"))return e;let r=l.default.relative(l.default.dirname(t),n.parentPath||n.path),s=`<script defer async src="${l.default.join(r,n.name)}"></script>`;return`${e}${s} `},mt=t=>(e,n)=>{if(!n.name.includes(".css"))return e;let r=l.default.relative(l.default.dirname(t),n.parentPath||n.path),s=`<link rel="stylesheet" href="${l.default.join(r,n.name)}">`;return`${e}${s} `};var u=x(require("path")),U=require("fs");var C=t=>new Promise((e,n)=>{(0,U.readdir)(t,{recursive:!0,withFileTypes:!0},(r,o)=>{r&&n(r),e(o)})}),_=async(t,e,n)=>{console.log("Reading folders..."),console.time("Folders read in");let r=p(n)?u.default.resolve(e,n):null,o=p(n)?u.default.resolve(t,n):null,s=r?await C(r):[],i=o?await C(o):[];return console.timeEnd("Folders read in"),console.log(""),{assetsSrcFolder:s,assetsOutFolder:i}},q=async t=>{console.log("Reading pages..."),console.time("Pages read in");let e=[];try{let n=u.default.resolve(t),o=(await C(n)).filter(s=>s.name.includes(".html")).map(s=>{let i=u.default.resolve(s.path,s.name);return W(i)});e=await Promise.all(o),console.timeEnd("Pages read in"),console.log("")}catch(n){console.error(n)}return e},z=async(t,e,n)=>{p(t)&&(console.log("Copying assets..."),console.time("Assets copied in"),await R(u.default.resolve(e,t),u.default.resolve(n,t)),console.timeEnd("Assets copied in"),console.log(""))};var dt=t=>({name:"staticReactPlugin",setup:e=>{let n=process.cwd(),r=t.store||null,o=t.components||[],s=O(t.pagesDir),i=O(t.srcDir,n),a=w.default.basename(e.initialOptions.outdir),m=O(t.outDir||"build",n),c=[];e.onStart(async()=>{await I(m),c=await q(w.default.resolve(i,s)),await z(a,i,m)}),e.onEnd(async()=>{let g=[],P=await _(m,i,a),f=c.map(d=>{for(let b of o){let G=w.default.basename(d.path),{html:K,log:k}=J(b,d.content,G,r);p(k)&&g.push(k),d.content=K}let $=d.path;return d.path=L(m,s,d.path),d.content=M(d,$,P),N(d)}),y=g.length?g.reduce((d,$,b)=>b===0?`${d} ${$}`:`${d}, ${$}`,"Injected components:"):"No component injected";console.log(`${y}`),console.log(""),console.log("Creating optimized html..."),console.time("Html files wrote in"),await Promise.all(f),console.timeEnd("Html files wrote in"),console.log("")})}}),O=(t,e=null)=>{if(!p(t))throw new Error("Path must be a valid string");return e?w.default.resolve(e,t):t},gt=dt;
