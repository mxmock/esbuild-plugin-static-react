"use strict";var at=Object.create;var C=Object.defineProperty;var ct=Object.getOwnPropertyDescriptor;var lt=Object.getOwnPropertyNames;var mt=Object.getPrototypeOf,dt=Object.prototype.hasOwnProperty;var gt=(t,e)=>{for(var s in e)C(t,s,{get:e[s],enumerable:!0})},E=(t,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of lt(e))!dt.call(t,n)&&n!==s&&C(t,n,{get:()=>e[n],enumerable:!(r=ct(e,n))||r.enumerable});return t};var u=(t,e,s)=>(s=t!=null?at(mt(t)):{},E(e||!t||!t.__esModule?C(s,"default",{value:t,enumerable:!0}):s,t)),pt=t=>E(C({},"__esModule",{value:!0}),t);var Ft={};gt(Ft,{default:()=>Ct});module.exports=pt(Ft);var j=u(require("path"));var F=u(require("path")),J=u(require("sass")),B=u(require("postcss")),L=u(require("cssnano")),M=u(require("autoprefixer"));var I=u(require("path")),W=require("html-minifier-terser");var w=require("fs"),k=t=>new Promise((e,s)=>{(0,w.mkdir)(t,{recursive:!0},r=>{r&&s(r.message),e("Create folder ok")})}),R=t=>new Promise((e,s)=>{(0,w.rm)(t,{recursive:!0,force:!0},r=>{r&&s(r.message),e("Delete ok")})}),A=(t,e)=>new Promise((s,r)=>{(0,w.cp)(t,e,{recursive:!0},n=>{n&&r(n.message),s("Copy ok")})});var y=require("fs"),ut=(t,e="utf8")=>(t.setEncoding(e),new Promise((s,r)=>{let n="";t.on("data",o=>{n+=o}),t.on("end",()=>s(n)),t.on("error",o=>r(o))})),T=(t,e)=>(t.write(e),t.end(),new Promise((s,r)=>{t.on("finish",()=>s("Write stream finish")),t.on("error",n=>r(n.message))})),N=async t=>{let e="";try{let s=(0,y.createReadStream)(t,{highWaterMark:100}),r=await ut(s);e=await(0,W.minify)(r,{caseSensitive:!0,collapseWhitespace:!0,conservativeCollapse:!0})}catch(s){console.error(s.message)}finally{return{path:t,content:e}}},H=async t=>{try{await k(I.default.dirname(t.path));let e=(0,y.createWriteStream)(t.path);await T(e,t.content)}catch(e){console.log(e)}},z=async(t,e)=>{try{await k(I.default.dirname(t));let s=(0,y.createWriteStream)(t);await T(s,e)}catch(s){console.log(s)}};var ft=t=>typeof t=="string",p=t=>ft(t)&&t.length>0;var U=u(require("cssnano-preset-default")),_=async(t,e,s,r)=>{if(!p(t)||!p(e))return;console.log("Create optimized css..."),console.time("Css created in");let n=(0,U.default)(),o=F.default.join(s,e,t);try{let{css:i}=await J.compileAsync(o),c=await(0,B.default)([(0,L.default)({preset:n,plugins:[M.default]})]).process(i,{from:void 0}),l=`${F.default.basename(t,".scss")}.css`,a=F.default.join(r,e,l);await z(a,`${c.css}`),console.timeEnd("Css created in"),console.log("")}catch(i){console.error(i.message)}};var q=require("react-redux"),G=require("react-dom/server"),S=require("react/jsx-runtime"),K=(t,e,s,r)=>{let{id:n,Content:o}=t,i=`id="${n}"`,c=`data-${n}=`;if(!e.includes(i))return{log:"",html:e};let l=e.indexOf(i),a=ht(e,c,l),f=r?(0,S.jsx)(q.Provider,{store:r,children:(0,S.jsx)(o,{...a})}):(0,S.jsx)(o,{...a}),d=(0,G.renderToString)(f),h=`${n} injected in ${s}`;return{log:a&&Object.keys(a).length>0?`${h} with data ${JSON.stringify(a)}`:h,html:Pt(d,e,l,i.length+1)}},ht=(t,e,s)=>{if(!t.includes(e))return{};let r=t.indexOf(e)+e.length+1,n=s-2,o=t.substring(r,n);try{return JSON.parse(o)}catch(i){return console.error(`getComponentData - cannot parse ${o} from html:`,i.message),{}}},Pt=(t,e,s,r)=>{let n=e.substring(0,s+r),o=e.substring(s+r);return`${n}${t}${o}`};var m=u(require("path")),V=(t,e,s)=>{let r=s.indexOf(e),n=s.slice(r+e.length);return m.default.join(t,n)},Q=(t,e)=>`${m.default.relative(m.default.dirname(t),m.default.dirname(e))}/${m.default.basename(e)}`,wt=(t,e,s,r,n)=>{let o=t;for(let i=0;i<r.length;i++){let c=r[i],l=n[i];if(c.name.includes(".")&&l.name.includes(".")&&o.includes(c.name)){let a=m.default.resolve(c.path,c.name),f=m.default.resolve(l.path,l.name),d=Q(e,a),h=Q(s,f);o=o.replace(d,h)}}return o},X=(t,e,s)=>{let{content:r,path:n}=t,{jsFolder:o,cssFolder:i,assetsSrcFolder:c,assetsOutFolder:l}=s,a=yt(r),f=o.reduce(vt(n),""),d=i.reduce($t(n),"");return a=a.replace(" </head>",`${d}</head>`),a=a.replace(" </body>",`${f}</body>`),wt(a,e,n,c,l)},yt=t=>{let e=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>|<link\b[^>]*?rel="stylesheet"[^>]*?>/gi;return t.replace(e,"")},vt=t=>(e,s)=>{let r=m.default.relative(m.default.dirname(t),s.path),o=`<script defer async src="${m.default.join(r,s.name)}"></script>`;return`${e}${o} `},$t=t=>(e,s)=>{let r=m.default.relative(m.default.dirname(t),s.path),o=`<link rel="stylesheet" href="${m.default.join(r,s.name)}">`;return`${e}${o} `};var P=u(require("path")),Y=require("fs");var v=t=>new Promise((e,s)=>{(0,Y.readdir)(t,{recursive:!0,withFileTypes:!0},(r,n)=>{r&&s(r),e(n)})}),Z=async(t,e,s,r,n)=>{console.log("Reading folders..."),console.time("Folders read in");let o=P.default.resolve(t,s),i=p(r)?P.default.resolve(t,r):null,c=p(n)?P.default.resolve(e,n):null,l=p(n)?P.default.resolve(t,n):null,a=await v(o),f=i?await v(i):[],d=c?await v(c):[],h=l?await v(l):[];return console.timeEnd("Folders read in"),console.log(""),{jsFolder:a,cssFolder:f,assetsSrcFolder:d,assetsOutFolder:h}},tt=async t=>{console.log("Reading pages..."),console.time("Pages read in");let e=[];try{let s=P.default.resolve(t),n=(await v(s)).filter(o=>o.name.includes(".html")).map(o=>{let i=P.default.resolve(o.path,o.name);return N(i)});e=await Promise.all(n),console.timeEnd("Pages read in"),console.log("")}catch(s){console.error(s)}finally{return e}},et=async(t,e,s)=>{p(t)&&(console.log("Copying assets..."),console.time("Assets copied in"),await A(P.default.resolve(e,t),P.default.resolve(s,t)),console.timeEnd("Assets copied in"),console.log(""))};var xt=(t={})=>({name:"staticReactPlugin",setup:e=>{let s=process.cwd(),r=t.css?.dir,n=t.store||null,o=t.assetsDir,i=t.css?.name,c=b(t.pagesDir),l=b(t.jsOutDir),a=b(t.srcDir,s),f=t.components||[],d=b(t.outDir||"build",s),h=[];e.onStart(async()=>{await R(d),h=await tt(j.default.resolve(a,c)),await et(o,a,d),await _(i,r,a,d)}),e.onEnd(async()=>{let $=[],st=await Z(d,a,l,r,o),rt=h.map(g=>{for(let O of f){let ot=j.default.basename(g.path),{html:it,log:D}=K(O,g.content,ot,n);p(D)&&$.push(D),g.content=it}let x=g.path;return g.path=V(d,c,g.path),g.content=X(g,x,st),H(g)}),nt=$.length?$.reduce((g,x,O)=>O===0?`${g} ${x}`:`${g}, ${x}`,"Injected components:"):"No component injected";console.log(`${nt}`),console.log(""),console.log("Creating optimized html..."),console.time("Html files wrote in"),await Promise.all(rt),console.timeEnd("Html files wrote in"),console.log("")})}}),b=(t,e=null)=>{if(!p(t))throw new Error("Path must be a valid string");return e?j.default.resolve(e,t):t},Ct=xt;
